# terraform-fsxwin-aws - configure
This folder contains Terraform configurations that deploy an AD domain joined EC2 instance used for configuring the FSx file system.

* In the ```user-data.ps1``` script that is run when the [EC2 instance](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-add-user-data.html) boots up for the first time, the custom DNS alias is added using [AWS CLI](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/fsx/associate-file-system-aliases.html) command ```aws fsx associate-file-system-aliases```. This is because at the time of this writing (May 20, 2021) there is still no support for adding DNS aliases to FSx in [Terraform](https://github.com/hashicorp/terraform-provider-aws/issues/16548). 
* The ```configure-fsx.ps1``` script is downloaded from S3 bucket to **C:\scripts** folder on the EC2 instance and needs to be run after the instance rebooted to complete the domain join. This script is based on AWS documentation [Walkthrough 5: Using DNS aliases to access your file system](https://docs.aws.amazon.com/fsx/latest/WindowsGuide/walkthrough05-file-system-custom-CNAME.html) and it takes two input parameters: ```$FileSystemId``` and ```$FileSystemAlias```. Running this script is idempotent: running it multiple times produces the same result. 
* This solution only covers adding one DNS alias to your Amazon FSx file system. If you need more aliases you can associate up to 50 using the [Amazon FSx console](https://docs.aws.amazon.com/fsx/latest/WindowsGuide/walkthrough05-file-system-custom-CNAME.html) or CLI and then run the ```configure-fsx.ps1``` for each alias to create the corresponding [SPNs](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names#:~:text=A%20service%20principal%20name%20(SPN,not%20have%20the%20account%20name.) and DNS records.
* For further configuration of your Amazon FSx file system you can use the OPS EC2 instance deployed here as it has all the necessary features installed. Check out [this](https://docs.aws.amazon.com/fsx/latest/WindowsGuide/remote-pwrshell.html) document for more details on how to administer the FSx file system with PowerShell. If you already have an OPS instance joined to domain you can run ```terraform destroy``` in this folder once the DNS alias was added.